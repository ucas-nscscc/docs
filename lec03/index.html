
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lec02/">
      
      
        <link rel="next" href="../lec04/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.14">
    
    
      
        <title>Lec 03 - SOC 搭建 - UCAS NSCSCC</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.85bb2934.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lec-03-soc" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="UCAS NSCSCC" class="md-header__button md-logo" aria-label="UCAS NSCSCC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            UCAS NSCSCC
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lec 03 - SOC 搭建
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="UCAS NSCSCC" class="md-nav__button md-logo" aria-label="UCAS NSCSCC" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    UCAS NSCSCC
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        NSCSCC 2023
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lec01/" class="md-nav__link">
        Lec 01 - “龙芯杯”大赛介绍
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lec02/" class="md-nav__link">
        Lec 02 - git 协作与软硬协同
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Lec 03 - SOC 搭建
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Lec 03 - SOC 搭建
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rtl-ip" class="md-nav__link">
    将 RTL 代码封装为 IP 核
  </a>
  
    <nav class="md-nav" aria-label="将 RTL 代码封装为 IP 核">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    封装前的配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip" class="md-nav__link">
    在临时工程中配置 IP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bd-soc" class="md-nav__link">
    使用 BD 功能搭建 SOC
  </a>
  
    <nav class="md-nav" aria-label="使用 BD 功能搭建 SOC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip_1" class="md-nav__link">
    导入 IP 仓库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#soc" class="md-nav__link">
    搭建 SOC 框架
  </a>
  
    <nav class="md-nav" aria-label="搭建 SOC 框架">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mycpu" class="md-nav__link">
    添加 mycpu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axi-crosscar" class="md-nav__link">
    添加 AXI Crosscar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    添加时钟与复位系统
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    添加存储器与 IO 设备
  </a>
  
    <nav class="md-nav" aria-label="添加存储器与 IO 设备">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#boot-rom" class="md-nav__link">
    添加 Boot ROM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boot-rom_1" class="md-nav__link">
    设置 Boot ROM 的映射地址
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lec04/" class="md-nav__link">
        Lec 04 - SOC 上板与系统启动
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../lec05/" class="md-nav__link">
        Lec 05 - 串口通信
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          杂项
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          杂项
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/linux/" class="md-nav__link">
        Linux 操作系统杂谈
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/lec02/" class="md-nav__link">
        对于 lec 02 的一些补充
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/vivado/" class="md-nav__link">
        在 Linux 上使用 Vivado 可能遇到的问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../misc/application-qa/" class="md-nav__link">
        报名问答集锦
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rtl-ip" class="md-nav__link">
    将 RTL 代码封装为 IP 核
  </a>
  
    <nav class="md-nav" aria-label="将 RTL 代码封装为 IP 核">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    封装前的配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ip" class="md-nav__link">
    在临时工程中配置 IP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bd-soc" class="md-nav__link">
    使用 BD 功能搭建 SOC
  </a>
  
    <nav class="md-nav" aria-label="使用 BD 功能搭建 SOC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ip_1" class="md-nav__link">
    导入 IP 仓库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#soc" class="md-nav__link">
    搭建 SOC 框架
  </a>
  
    <nav class="md-nav" aria-label="搭建 SOC 框架">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mycpu" class="md-nav__link">
    添加 mycpu
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#axi-crosscar" class="md-nav__link">
    添加 AXI Crosscar
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    添加时钟与复位系统
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    添加存储器与 IO 设备
  </a>
  
    <nav class="md-nav" aria-label="添加存储器与 IO 设备">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#boot-rom" class="md-nav__link">
    添加 Boot ROM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boot-rom_1" class="md-nav__link">
    设置 Boot ROM 的映射地址
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="lec-03-soc">Lec 03 - SOC 搭建</h1>
<p>本次培训将指导大家使用 Vivado 的 Block Design 功能搭建自己的 SOC，并在此基础上添加存储器与 GPIO 控制器，形成最小计算机系统。</p>
<h2 id="rtl-ip">将 RTL 代码封装为 IP 核</h2>
<p>经过本周的实验，大家的 CPU 核已经改为向外暴露一个 AXI 接口，从而使得<em>片上互联</em>与<em>外设扩展</em>变得简单。我们使用 Vivado 提供的 Block Design（简称为 BD）功能便能搭建出一个基于 AXI 总线的 SOC，并能方便地进行外设扩展。而在 BD 中，搭建的单位由 Verilog 源码变为了 IP 核，因此需要将 SOC 中的主从设备先封装为 IP 核。</p>
<p>以封装 mycpu 为 IP 核为例，从 RTL 代码到 IP 核的过程为：</p>
<ul>
<li>新建 Vivado 工程，其中仅包含 mycpu 的 RTL 源码，即顶层模块为 <code>mycpu_top</code></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>如果你的 CPU 核中调用了 Xilinx IP 核，那么需要将 IP 核一同加入到工程中。如果想要在新项目中加入一个已经在其他项目中定制的 IP 核，那么<strong>无需重新定制</strong>，只需要将描述 IP 核的 <code>.xci</code> 文件添加到项目中即可，添加方式与添加 RTL 源码相同。<code>.xci</code> 文件具体的位置为 <code>&lt;Project Home&gt;/*.srcs/sources_1/ip/&lt;IP Name&gt;/*.xci</code>。</p>
</div>
<ul>
<li>将 <code>mycpu_top.v</code> 中的 <code>debug_wb_*</code> 接口注释掉，这是为了后续定义 IP 接口时不产生混淆</li>
</ul>
<h3 id="_1">封装前的配置</h3>
<ul>
<li>
<p>点击 Tools <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Create and Package New IP... 选项，开始封装一个 IP 核：</p>
<p><img alt="" src="../img/lec03/create-and-package.png" /></p>
</li>
<li>
<p>而后，将弹出一个设置界面，点击 Next：</p>
<p><img alt="" src="../img/lec03/cpni-1.png" /></p>
</li>
<li>
<p>选择 Package your current project，设置封装目标为当前项目，然后点击 Next：</p>
<p><img alt="" src="../img/lec03/cpni-2.png" /></p>
</li>
<li>
<p>接下来在 IP location 输入框中输入自定义路径，该路径为 IP 文件的输出路径，然后点击 Next：</p>
<p><img alt="" src="../img/lec03/cpni-3.png" /></p>
</li>
<li>
<p>之后将弹出一个窗口询问是否拷贝源码，点击 OK：</p>
<p><img alt="" src="../img/lec03/cpni-4.png" /></p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>如果 IP location 填写的路径下已经存在了之前封装过的 IP，则会弹出一个窗口询问是否覆盖，为了创建最新版本的 IP，点击 Overwrite：
<img alt="" src="../img/lec03/cpni-5.png" /></p>
</div>
<ul>
<li>
<p>最后，点击 Finish，将会弹出一个新的临时工程用于配置 IP：</p>
<p><img alt="" src="../img/lec03/cpni-6.png" /></p>
</li>
</ul>
<h3 id="ip">在临时工程中配置 IP</h3>
<p>弹出的临时工程将自动打开 Package IP 的配置界面，按照下面的步骤对 mycpu IP 进行配置。</p>
<ul>
<li>
<p>点击 Ports and Interfaces <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> 右键 interface_aximm<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Edit Interface配置 mycpu 对外暴露的 AXI 接口：</p>
<p><img alt="" src="../img/lec03/pi-1.png" /></p>
</li>
<li>
<p>在弹出的窗口中，可以看到对该接口的配置信息，切换到 Port Mapping 选项卡，在<strong>最下面</strong>的窗口中检查 AXI 接口信号（左侧大写）与 <code>mycpu_top</code> 中的信号（右侧小写）是否匹配<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>：</p>
<p><img alt="" src="../img/lec03/pi-2.png" /></p>
</li>
<li>
<p>切换到 Parameters 选项卡，配置接口的参数。点击右侧的 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.75 1h10.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25V2.75C1 1.784 1.784 1 2.75 1Zm10.5 1.5H2.75a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25ZM8 4a.75.75 0 0 1 .75.75v2.5h2.5a.75.75 0 0 1 0 1.5h-2.5v2.5a.75.75 0 0 1-1.5 0v-2.5h-2.5a.75.75 0 0 1 0-1.5h2.5v-2.5A.75.75 0 0 1 8 4Z"/></svg></span> 按钮创建参数，在弹出的窗口中输入参数名为 <code>FREQ_HZ</code>，创建完成后，该参数位于 Optional 中，修改 value 一列对应的值为 mycpu 的<strong>实际运行频率</strong>，建议为 50MHz：</p>
<p><img alt="" src="../img/lec03/pi-3.png" /></p>
</li>
<li>
<p>点击 OK 关闭 Edit Interface 窗口后，点击 Review and Package <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Package IP 按钮封装 IP：</p>
<p><img alt="" src="../img/lec03/pi-4.png" /></p>
</li>
<li>
<p>由于上一小节在 IP location 中填写的是该项目的位置，因此 IP 的 <code>.xml</code> 描述文件位于该项目的根目录下：</p>
<p><img alt="" src="../img/lec03/pi-5.png" /></p>
</li>
</ul>
<div class="admonition question">
<p class="admonition-title">练习</p>
<p>为了在搭建好的 SOC 上使用 GPIO 功能，我们需要将 AXI 接口的 confreg 也封装为 IP。仿照封装 mycpu 的方法，新建一个工程，将 confreg 也封装为 IP 核。</p>
</div>
<h2 id="bd-soc">使用 BD 功能搭建 SOC</h2>
<p>我们可以直接使用创建 IP 核的项目搭建 SOC，也可以新创建一个项目。这里选择新建一个名为 mysoc 的项目。首先，以 tcl 终端模式启动 Vivado：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>vivado<span class="w"> </span>-mode<span class="w"> </span>tcl

******<span class="w"> </span>Vivado<span class="w"> </span>v2019.2<span class="w"> </span><span class="o">(</span><span class="m">64</span>-bit<span class="o">)</span>
<span class="w">  </span>****<span class="w"> </span>SW<span class="w"> </span>Build<span class="w"> </span><span class="m">2708876</span><span class="w"> </span>on<span class="w"> </span>Wed<span class="w"> </span>Nov<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">21</span>:39:14<span class="w"> </span>MST<span class="w"> </span><span class="m">2019</span>
<span class="w">  </span>****<span class="w"> </span>IP<span class="w"> </span>Build<span class="w"> </span><span class="m">2700528</span><span class="w"> </span>on<span class="w"> </span>Thu<span class="w"> </span>Nov<span class="w">  </span><span class="m">7</span><span class="w"> </span><span class="m">00</span>:09:20<span class="w"> </span>MST<span class="w"> </span><span class="m">2019</span>
<span class="w">    </span>**<span class="w"> </span>Copyright<span class="w"> </span><span class="m">1986</span>-2019<span class="w"> </span>Xilinx,<span class="w"> </span>Inc.<span class="w"> </span>All<span class="w"> </span>Rights<span class="w"> </span>Reserved.

Vivado%<span class="w"> </span>
</code></pre></div>
<h3 id="ip_1">导入 IP 仓库</h3>
<p>启动完毕后，最底行显示的 <code>Vivado%</code> 相当于 shell 中的命令提示符，我们可以向终端输入命令来控制 Vivado 的行为。我们首先需要将创建的 IP 核导入新建的 Vivado 工程，使得在其中可以进行调用。</p>
<ul>
<li>
<p>创建 Vivado 工程 mysoc，并使用 tree 工具查看生成的工程：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">tcl console</label><label for="__tabbed_1_2">shell</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>Vivado%<span class="w"> </span>create_project<span class="w"> </span>-force<span class="w"> </span>./mysoc<span class="w"> </span>./mysoc<span class="w"> </span>-part<span class="w"> </span>xc7a200tfbg676-1
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>tree<span class="w"> </span>./mysoc
./mysoc/
├──<span class="w"> </span>mysoc.cache
│<span class="w">   </span>└──<span class="w"> </span>wt
│<span class="w">       </span>└──<span class="w"> </span>project.wpc
├──<span class="w"> </span>mysoc.hw
│<span class="w">   </span>└──<span class="w"> </span>mysoc.lpr
├──<span class="w"> </span>mysoc.ip_user_files
└──<span class="w"> </span>mysoc.xpr

<span class="m">4</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">3</span><span class="w"> </span>files
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>创建完成后，Vivado 已经默认在当前 tcl 终端中打开了 mysoc 工程，将刚才创建的 IP 核导入当前工程<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>：</p>
<div class="highlight"><pre><span></span><code>Vivado%<span class="w"> </span>set_property<span class="w">  </span>ip_repo_paths<span class="w">  </span><span class="o">{</span>&lt;Mycpu<span class="w"> </span>Home&gt;<span class="w"> </span>&lt;Confreg<span class="w"> </span>Home&gt;<span class="o">}</span><span class="w"> </span><span class="o">[</span>current_project<span class="o">]</span>
</code></pre></div>
</li>
</ul>
<h3 id="soc">搭建 SOC 框架</h3>
<ul>
<li>
<p>通过命令 <code>start_gui</code> 启动图形界面：</p>
<div class="highlight"><pre><span></span><code>Vivado%<span class="w"> </span>start_gui
</code></pre></div>
</li>
<li>
<p>启动图形界面后，点击 Flow Navigator <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> IP INTEGRATOR <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Create Block Design 创建一个 Block Design：</p>
<p><img alt="" src="../img/lec03/bd-1.png" /></p>
</li>
<li>
<p>而后在打开的 Diagram 选项卡中点击 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.75 1h10.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25V2.75C1 1.784 1.784 1 2.75 1Zm10.5 1.5H2.75a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25ZM8 4a.75.75 0 0 1 .75.75v2.5h2.5a.75.75 0 0 1 0 1.5h-2.5v2.5a.75.75 0 0 1-1.5 0v-2.5h-2.5a.75.75 0 0 1 0-1.5h2.5v-2.5A.75.75 0 0 1 8 4Z"/></svg></span> 添加 IP 核，由于已经添加了 IP 仓库，因此可以看到自定义的 mycpu_top_v1_0 IP 核：</p>
<p><img alt="" src="../img/lec03/bd-2.png" /></p>
</li>
</ul>
<h4 id="mycpu">添加 mycpu</h4>
<ul>
<li>
<p>双击 mycpu_top_v1_0，相应的原理图将出现在 Diagram 中：</p>
<p><img alt="" src="../img/lec03/bd-3.png" /></p>
<p>该原理图显示了 IP 核 mycpu_top_v1_0 中的所有接口，方框左侧为输入（从方）接口，右侧为输出（主方）接口。由于右侧为标准的主方 AXI 接口，因此所有的信号都包含在 interface_aximm 中，点击 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.75 1h10.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 13.25 15H2.75A1.75 1.75 0 0 1 1 13.25V2.75C1 1.784 1.784 1 2.75 1Zm10.5 1.5H2.75a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25ZM8 4a.75.75 0 0 1 .75.75v2.5h2.5a.75.75 0 0 1 0 1.5h-2.5v2.5a.75.75 0 0 1-1.5 0v-2.5h-2.5a.75.75 0 0 1 0-1.5h2.5v-2.5A.75.75 0 0 1 8 4Z"/></svg></span> 可以查看其中包含的信号。</p>
</li>
</ul>
<h4 id="axi-crosscar">添加 AXI Crosscar</h4>
<ul>
<li>
<p>下一步，需要创建基于 AXI 总线的片上互联结构，添加一个 AXI Crossbar：</p>
<p><img alt="" src="../img/lec03/bd-4.png" /></p>
</li>
</ul>
<h4 id="_2">添加时钟与复位系统</h4>
<ul>
<li>
<p>添加 AXI Crossbar 后，可以使用鼠标连接 mycpu 的主方 AXI 接口与 Crossbar 上的从方 AXI 接口。同时，在上方将弹出一个绿色的提示框，提示可以自动连接线路，点击 Run Connection Automation：</p>
<p><img alt="" src="../img/lec03/bd-5.png" /></p>
</li>
<li>
<p>自动连线后，Vivado 将自动引入时钟 IP Clocking Wizard 与复位 IP Processor System Reset 并完成部分线路的连接：</p>
<p><img alt="" src="../img/lec03/bd-6.png" /></p>
</li>
<li>
<p>我们需要重新定制 IP clk_wiz，双击该模块，在弹出的配置窗口中切换到 Output Clocks，配置 cpu_clk 为 50MHz，timer_clk 为 100MHz：</p>
<p><img alt="" src="../img/lec03/clk-1.png" /></p>
</li>
<li>
<p>将该选项卡拖动到最底下，将 Reset Type 设置为 Active Low：</p>
<p><img alt="" src="../img/lec03/clk-2.png" /></p>
</li>
<li>
<p>在点击 OK 保存设置后，Diagram 中连接 clk_wiz 的线路将自动断开，需要手动将 cpu_clk 接口连接到与 mycpu 中 aclk 接口相同的线路上：</p>
<p><img alt="" src="../img/lec03/clk-3.png" /></p>
</li>
<li>
<p>需要将 clk_wiz 上的 resetn 与 clk_in1 接口引出，最终约束到开发板的引脚上。将鼠标置于 clk_wiz 的 clk_in1 接口上，右键点击，在弹出的选项框中点击 Make External：</p>
<p><img alt="" src="../img/lec03/bd-7.png" /></p>
</li>
<li>
<p>使用同样的方法将 resetn 设置为外部接口，然后将 rst_clk_wiz_100M 的 ext_reset_in 信号连接到与 resetn 相同的线路上：</p>
<p><img alt="" src="../img/lec03/bd-8.png" /></p>
</li>
</ul>
<p>至此，一个基本的 SOC 框架就搭建完成了，我们可以根据需要在 SOC 中添加各种 AXI 设备。</p>
<p><img alt="" src="../img/lec03/soc.png" /></p>
<h3 id="io">添加存储器与 IO 设备</h3>
<p>Loongarch32r 的复位 PC 为 <code>0x1c00_0000</code>，因此必须将以该地址为基址的一片地址空间映射到一块存储器上。</p>
<h4 id="boot-rom">添加 Boot ROM</h4>
<ul>
<li>
<p>添加 Block Memory Generator IP 核：</p>
<p><img alt="" src="../img/lec03/BRAM-1.png" /></p>
</li>
<li>
<p>双击该 IP 核进行配置，需要将 Basic <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Mode 修改为 BRAM Controller，Basic <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Memory Type 修改为 Single Port ROM：</p>
<p><img alt="" src="../img/lec03/BRAM-2.png" /></p>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<ul>
<li>
<p>此处我们选择了 Read Only Memory（ROM）作为 Boot ROM，这是因为在 BD 中只有 ROM 才能使用 <code>.coe</code> 文件进行初始化。这样我们就无法将变量也保存在 ROM 中，因此稍后需要再添加一个 RAM，将它映射到其他地址段。通过 Boot ROM 的代码（即 bootloader）将真正要执行的程序加载到 RAM 中，再跳转到 RAM 中继续程序的执行。</p>
</li>
<li>
<p>此处我们无法设置存储器的深度，因为它的深度是随着稍后我们为它分配的地址空间大小自动变化的。</p>
</li>
</ul>
</div>
<ul>
<li>
<p>注意到该 IP 并不是 AXI 接口，而是 BRAM 接口，因此需添加一个 AXI BRAM Controller 进行转换：</p>
<p><img alt="" src="../img/lec03/BRAM-3.png" /></p>
</li>
<li>
<p>双击该 IP 核进行配置，将 BRAM Options <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> Number of BRAM interfaces 修改为 1：</p>
<p><img alt="" src="../img/lec03/BRAM-4.png" /></p>
</li>
<li>
<p>连接 axi_crossbar_0 的 M00_AXI <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> axi_bram_ctrl_0 的 S_AXI，axi_bram_ctrl_0 的 BRAM_PORTA <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> blk_mem_gen_0 的 BRAM_PORTA：</p>
<p><img alt="" src="../img/lec03/BRAM-5.png" /></p>
</li>
<li>
<p>点击 Run Connection Automation 自动连接时钟与复位信号：</p>
<p><img alt="" src="../img/lec03/BRAM-6.png" /></p>
</li>
</ul>
<h4 id="boot-rom_1">设置 Boot ROM 的映射地址</h4>
<ul>
<li>
<p>切换到 Address Editor 选项卡即可为 SOC 中的从设备分配地址。右键点击 Unmapped Slaves <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg></span> axi_bram_ctrl_0，选择 Assign Address 为 Boot ROM 配置地址：</p>
<p><img alt="" src="../img/lec03/am-1.png" /></p>
</li>
<li>
<p>将 Offset Address 改为 <code>0x1C00_0000</code>，Range 修改为 <code>32K</code>：</p>
<p><img alt="" src="../img/lec03/am-2.png" /></p>
</li>
<li>
<p>回到 Diagram，点击工具栏中的 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V5h10V3H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-8h-2m-11.09-.92L6.5 11.5 11 16 21 6l-1.41-1.42L11 13.17l-3.09-3.09Z"/></svg></span> Validate Design 按钮检查 SOC 中的连线是否正确，而后查看 axi_bram_ctrl_0 中 BRAM_PORTA 接口下 bram_addr_a 的宽度：</p>
<p><img alt="" src="../img/lec03/am-3.png" /></p>
<p>此时地址宽度已自动设置为与 32KB 相对应的 15 位。</p>
</li>
</ul>
<div class="admonition question">
<p class="admonition-title">练习</p>
<ul>
<li>仿照添加 Boot ROM 的方法，添加一个 RAM 到 SOC 中，分配地址为：基址 <code>0x1C00_8000</code>，范围 <code>32K</code></li>
<li>将 confreg IP 核添加到 SOC 中，分配地址为：基址 <code>0xBFAF_0000</code>，范围 <code>64K</code>（提示：需要重新定制 axi_crossbar_0，增加 Master Interfece 的数量；同时添加完成后需要将一些接口设置为 External）</li>
</ul>
</div>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>实际接口名称可能不是 interface_aximm&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>之前注释 <code>debug_wb_*</code> 信号就是为了这一部几乎无需修改映射信息&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>需要将 <code>&lt;Mycpu Home&gt;</code> 和 <code>&lt;Confreg Home&gt;</code> 分别替换为封装 mycpu 和 confreg 的工程根目录&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>